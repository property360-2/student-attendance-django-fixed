{% extends 'base.html' %}
{% block title %}Dashboard ¬∑ Student Attendance{% endblock %}
{% block content %}
{% include 'components/organisms/stats-cards.html' with total_students=total_students present=present absent=absent late=late today=today %}

<div class="panel">
    <div class="panel-header">
        <h3>Quick Actions</h3>
    </div>
    <div class="actions">
        {% include 'components/atoms/button.html' with label='Add Student' href='/students/add/' type='link' %}
        {% include 'components/atoms/button.html' with label='Mark Attendance' href='/attendance/mark/' type='link' %}
        {% include 'components/atoms/button.html' with label='View All Attendance' href='/attendance/' type='link' %}
        {% include 'components/atoms/button.html' with label='Logout' href='/accounts/logout/' type='link' %}
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h3>Attendance Dates</h3>
        <div class="panel-actions">
            {% include 'components/atoms/button.html' with label='View All Dates' href='/attendance/' type='link' %}
        </div>
    </div>
    <div class="table-responsive">
        {% if dates_with_stats %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Late</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for date_stat in dates_with_stats %}
                <tr>
                    <td><strong>{{ date_stat.date }}</strong></td>
                    <td>
                        {% include 'components/atoms/badge.html' with text=date_stat.present tone='present' %}
                    </td>
                    <td>
                        {% include 'components/atoms/badge.html' with text=date_stat.absent tone='absent' %}
                    </td>
                    <td>
                        {% include 'components/atoms/badge.html' with text=date_stat.late tone='late' %}
                    </td>
                    <td>{{ date_stat.total }}</td>
                    <td>
                        <a href="/attendance/?date={{ date_stat.date|date:'Y-m-d' }}" class="link">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-center">No attendance records yet.</p>
        {% endif %}
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h3>Student Attendance Summary</h3>
        <div class="panel-actions">
            <form method="get" class="inline" style="margin:0;">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search student..." class="input" style="width:250px;">
                <button type="submit" class="btn">Search</button>
                {% if search_query %}
                <a href="?" class="btn secondary">Clear</a>
                {% endif %}
            </form>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th style="width:60px;">Rank</th>
                    <th>Student</th>
                    <th>Total Records</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Late</th>
                    <th>Points</th>
                    <th>Most Common</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in students_with_stats %}
                <tr{% if stat.is_late_risk %} class="row-late-risk"{% endif %}>
                    <td>
                        {% if stat.rank == 1 %}
                        <span class="badge success" style="font-size:16px; padding:6px 10px;">ü•á #{{ stat.rank }}</span>
                        {% elif stat.rank == 2 %}
                        <span class="badge" style="font-size:16px; padding:6px 10px; background:#2563eb; color:#fff;">ü•à #{{ stat.rank }}</span>
                        {% elif stat.rank == 3 %}
                        <span class="badge" style="font-size:16px; padding:6px 10px; background:#d97706; color:#fff;">ü•â #{{ stat.rank }}</span>
                        {% elif stat.rank %}
                        <span style="font-weight:600; color:var(--muted);">#{{ stat.rank }}</span>
                        {% else %}
                        <span style="font-weight:600; color:var(--muted);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ stat.student.last_name }}, {{ stat.student.first_name }}</strong><br>
                        <small class="text-muted">{{ stat.student.student_id }}</small>
                        {% if stat.student.class_section %}
                        <br><small class="text-muted">Class: {{ stat.student.class_section }}</small>
                        {% endif %}
                        {% if stat.is_perfect %}
                        <div>
                            <span class="badge success" style="margin-top:4px;">‚≠ê Perfect Attendance</span>
                        </div>
                        {% endif %}
                        {% if stat.is_late_risk %}
                        <div>
                            <span class="badge danger" style="margin-top:4px;">‚ö† Frequently Late</span>
                        </div>
                        {% endif %}
                    </td>
                    <td>{{ stat.total_records }}</td>
                    <td>
                        {% if stat.total_records > 0 %}
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span>{{ stat.present_count }}</span>
                            <span class="text-muted">({{ stat.present_pct }}%)</span>
                        </div>
                        <div class="progress-bar" style="width: {{ stat.present_pct }}%; background-color: #16a34a;"></div>
                        {% else %}
                        <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat.total_records > 0 %}
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span>{{ stat.absent_count }}</span>
                            <span class="text-muted">({{ stat.absent_pct }}%)</span>
                        </div>
                        <div class="progress-bar" style="width: {{ stat.absent_pct }}%; background-color: #dc2626;"></div>
                        {% else %}
                        <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat.total_records > 0 %}
                        <strong>{{ stat.points|floatformat:1 }}</strong>
                        {% else %}
                        <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat.total_records > 0 %}
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span>{{ stat.late_count }}</span>
                            <span class="text-muted">({{ stat.late_pct }}%)</span>
                        </div>
                        <div class="progress-bar" style="width: {{ stat.late_pct }}%; background-color: #d97706;"></div>
                        {% else %}
                        <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat.most_common_status %}
                        {% include 'components/atoms/badge.html' with text=stat.most_common_status|title tone=stat.most_common_status %}
                        <small>({{ stat.most_common_count }}x)</small>
                        {% else %}
                        <span class="text-muted">No records</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/attendance/?student={{ stat.student.id }}" class="link">View Records</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No students found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h3>Attendance Charts</h3>
    </div>
    <div class="charts-grid" id="charts-container">
        {% for chart in chart_data.charts_by_month %}
        <div class="chart-container">
            <h4>{{ chart.month_label }}</h4>
            <canvas id="chart-{{ chart.month_key }}"></canvas>
        </div>
        {% empty %}
        <p class="text-center">No attendance records yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ chart_data|json_script:"attendance-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function () {
    const el = document.getElementById('attendance-chart-data');
    if (!el) return;
    const data = JSON.parse(el.textContent);

    if (!data.charts_by_month || data.charts_by_month.length === 0) return;

    // Create a chart for each month
    data.charts_by_month.forEach(function(chartData) {
      const canvasId = 'chart-' + chartData.month_key;
      const ctx = document.getElementById(canvasId);
      if (!ctx || chartData.labels.length === 0) return;

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'Present',
              data: chartData.present,
              borderColor: '#16a34a',
              backgroundColor: 'rgba(22,163,74,0.15)',
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
            },
            {
              label: 'Absent',
              data: chartData.absent,
              borderColor: '#dc2626',
              backgroundColor: 'rgba(220,38,38,0.15)',
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
            },
            {
              label: 'Late',
              data: chartData.late,
              borderColor: '#d97706',
              backgroundColor: 'rgba(217,119,6,0.15)',
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          layout: {
            padding: {
              left: 10,
              right: 10,
              top: 10,
              bottom: 10,
            },
          },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                font: {
                  size: 13,
                },
                padding: 15,
              },
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12,
              titleFont: {
                size: 14,
              },
              bodyFont: {
                size: 13,
              },
            },
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                font: {
                  size: 11,
                },
                padding: 8,
              },
              grid: {
                display: true,
                color: 'rgba(0,0,0,0.05)',
              },
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                },
                padding: 8,
              },
              grid: {
                display: true,
                color: 'rgba(0,0,0,0.05)',
              },
            },
          },
          interaction: {
            intersect: false,
            mode: 'index',
          },
        },
      });
    });

  })();
</script>
{% endblock %}
